<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Want-æ„æ€æ±ºå®šæ”¯æ´ãƒ„ãƒ¼ãƒ«</title>

<!-- PWA -->
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#7dd3fc">

<style>
:root {
  --bg: #071226;
  --card: #07192a;
  --text: #e6eef8;
  --muted: #9fb4c7;
  --accent: #7dd3fc;
  --good: #38b000;
  --warn: #ffb020;
  --bad: #ef4444;
  --pill-bg: rgba(255,255,255,0.02);
}
/* å±¥æ­´ãƒœã‚¿ãƒ³é–“ã®éš™é–“ã‚’ç¢ºä¿ */
.hist-top > div:last-child {
  display: flex;
  gap: 6px; /* â† ã“ã“ã§èª­ã¿è¾¼ã¿ã¨å‰Šé™¤ãƒœã‚¿ãƒ³é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’6pxã« */
}

/* ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ */
:root.light {
  --bg: #f5f7fa;
  --card: #ffffff;
  --text: #1a1a1a;
  --muted: #4a5568;
  --accent: #0099cc;
  --good: #00a33a;
  --warn: #e6a700;
  --bad: #cc0000;
  --pill-bg: rgba(0,0,0,0.04);
}

html, body {
  margin:0;padding:16px;
  font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue","Yu Gothic UI",Meiryo,sans-serif;
  background:var(--bg);color:var(--text);
}
body{line-height:1.5;transition:background 0.3s,color 0.3s;}
.wrap{max-width:640px;margin:0 auto;display:flex;flex-direction:column;gap:16px;}
h1{font-size:1.4rem;margin:0;}
.formula{font-size:0.9rem;color:var(--muted);}
.card{
  background:var(--card);border-radius:12px;padding:16px;
  display:flex;flex-direction:column;gap:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.5);
  transition:background 0.3s,color 0.3s;
}
label{font-size:0.9rem;color:var(--muted);}
input, select, textarea{
  width:100%;padding:10px;border-radius:8px;
  border:1px solid rgba(255,255,255,0.1);
  background:rgba(255,255,255,0.05);
  color:var(--text);font-size:1rem;box-sizing:border-box;
  transition:background 0.3s,color 0.3s,border 0.3s;
}
:root.light input, :root.light select, :root.light textarea {
  background:rgba(0,0,0,0.03);
  border:1px solid rgba(0,0,0,0.1);
}
textarea{resize:vertical;min-height:56px;}
button{border:0;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;transition:background 0.3s;}
.btn-primary{background:var(--accent);color:#042029;}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.1);color:var(--text);}
.btn-small{padding:8px 10px;font-weight:600;border-radius:8px;}
.btn-danger{background:var(--bad);color:white;padding:8px;border-radius:8px;}
.result-line{padding:10px;border-radius:8px;background:var(--pill-bg);display:flex;justify-content:space-between;font-weight:700;}
.result-judge{padding:10px;border-radius:8px;background:var(--pill-bg);font-weight:700;}
.history-list{display:flex;flex-direction:column;gap:8px;max-height:300px;overflow:auto;}
.hist-item{display:flex;flex-direction:column;padding:10px;border-radius:8px;background:rgba(255,255,255,0.01);}
.hist-top{display:flex;justify-content:space-between;align-items:center;}
.hist-meta{font-size:0.85rem;color:var(--muted);}
.hist-memo{font-weight:800;margin-top:6px;}
footer{font-size:0.82rem;color:var(--muted);text-align:center;margin-top:16px;padding-bottom:16px;}
.flex-row{display:flex;gap:8px;align-items:center;}
.theme-toggle{position:fixed;top:12px;right:16px;background:var(--accent);color:#fff;padding:6px 10px;border:none;border-radius:8px;font-size:0.9rem;cursor:pointer;}
#clearAllBtn {width: 60px;line-height: 1.2;text-align: center;white-space: normal;}
:root.light .btn-ghost,:root.light .btn-small {border: 1px solid rgba(0, 0, 0, 0.3) !important;}
:root.light .btn-primary,:root.light .btn-danger {border: none !important;}

/* ====== E'ãƒãƒ¼ ====== */
.e-bar-container {
  position: relative;
  width: 100%;
  height: 28px;
  background: black;
  border-radius: 14px;
  overflow: hidden;
  margin-top: 8px;
  margin-bottom: 6px;
}
.e-bar-fill {
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  background: black;
  border-radius: 14px;
  transition: width 0.6s ease, background 0.4s ease;
}
/* â† ä¿®æ­£ç‰ˆï¼šå·¦å¯„ã›è¡¨ç¤º */
.e-bar-value {
  position: absolute;
  top: 50%;
  left: 8px;
  transform: translateY(-50%);
  font-weight: 800;
  font-size: 1.0rem;
  color: var(--text);
  text-shadow: 0 0 4px rgba(0,0,0,0.6);
}
.e-bar-line {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 50%;
  width: 2px;
  background: var(--text);
  opacity: 0.6;
  transform: translateX(-50%);
}
.e-axis {
  position: relative;
  width: 100%;
  height: 20px;
  margin-top: 4px;
  display: flex;
  justify-content: space-between;
  font-size: 0.75rem;
  color: var(--muted);
  flex-wrap: wrap;
}
.e-axis div {
  position: relative;
  text-align: center;
  flex: 1;
}
/* ===== ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰èª¿æ•´: E'ãƒãƒ¼ ===== */
:root.light .e-bar-container {
  background: rgba(0,0,0,0.1);  /* æ˜ã‚‹ã‚ã®ä¸‹åœ° */
}

:root.light .e-bar-fill {
  background: rgba(0,150,255,0.3);  /* åˆæœŸæ™‚ã¯æ·¡ã„æ°´è‰² */
}

:root.light .e-bar-value {
  color: #1a1a1a; /* é»’ç³»æ–‡å­—ã§è¦–èªæ€§UP */
  text-shadow: 0 0 2px rgba(255,255,255,0.5);
}

:root.light .e-bar-line {
  background: rgba(0,0,0,0.3);
}
</style>
</head>

<body>
<button id="themeToggle" class="theme-toggle">ğŸŒ™</button>

<div class="wrap">
  <header>
    <h1>Want-æ„æ€æ±ºå®šæ”¯æ´ãƒ„ãƒ¼ãƒ«</h1>
    <div class="formula">W = I Ã— âˆšTâ€ƒâ€ƒE' = W / (k Ã— âˆšC)</div>
  </header>

  <!-- å…¥åŠ›ã‚«ãƒ¼ãƒ‰ -->
  <section class="card">
    <label>I : Wantã®å¼·åº¦ï¼ˆ1ã€œ100ï¼‰</label>
    <input id="I" type="number" min="0" max="100" step="0.1" placeholder="ä¾‹: 40">

    <label>T: Wantã®æŒç¶šæœŸé–“ï¼ˆæ—¥æ•°æ›ç®—ï¼‰</label>
    <div class="flex-row">
      <input id="T" type="number" min="1" step="1" placeholder="ä¾‹: 10" style="flex:2;">
      <select id="Tunit" style="flex:1;">
        <option value="day">æ—¥</option>
        <option value="week">é€±</option>
        <option value="month">æœˆ</option>
        <option value="year">å¹´</option>
      </select>
    </div>

    <label>Cï¼ˆè²»ç”¨, å††ï¼‰</label>
    <input id="C" type="number" min="0" step="1" placeholder="ä¾‹: 5000">

    <label>kï¼ˆã‚¹ã‚±ãƒ¼ãƒ«å®šæ•°ï¼‰: é‡‘éŠ­æ„Ÿè¦š</label>
    <input id="k" type="number" min="0.0001" step="0.0001" placeholder="å¿…é ˆï¼ˆè‡ªå‹•è¨ˆç®—ã‚‚å¯ï¼‰">

<hr style="border:none; border-top:1px solid var(--muted); opacity:0.3; margin:12px 0 6px 0;">
<label style="display:block; font-weight:600; color:var(--accent);">
  kã‚’ç®—å‡ºã™ã‚‹æ–¹æ³• â†“
</label>

<label style="margin-top:4px;">â‘  äºˆæœŸã›ã¬ä¸€ç›®æƒšã‚Œå•†å“ã®è¨±å®¹é¡ï¼ˆå††ï¼‰</label>
<div class="flex-row">
  <input id="C0" type="number" min="1" step="1" placeholder="ä¾‹: 10000" style="flex:1;">
  <button id="calibrateBtn" class="btn-ghost btn-small" style="white-space:nowrap;">kç®—å‡º</button>
</div>

<label>â‘¡ æœˆã®ãŠå°é£ã„é‡‘é¡ï¼ˆå††ï¼‰</label>
<div class="flex-row" style="margin-bottom:8px;">
  <input id="income" type="number" min="1" step="1" placeholder="ä¾‹: 30000" style="flex:1;">
  <button id="incomeBtn" class="btn-ghost btn-small" style="white-space:nowrap;">kç®—å‡º</button>
</div>

<div style="display:flex;gap:8px;flex-wrap:wrap;">
  <button id="calcBtn" class="btn-primary">çµæœ</button>
  <button id="saveBtn" class="btn-ghost btn-small">å±¥æ­´ä¿å­˜</button>
  <button id="exportBtn" class="btn-ghost btn-small">CSVå‡ºåŠ›</button>
</div>
</section>

<!-- çµæœ -->
<section class="card">
  <div class="result-line">Wï¼ˆWantã®ç·é‡ï¼‰ <span id="Wout">â€”</span></div>
  <div class="result-line">E'ï¼ˆå¿ƒç†çš„ã‚³ã‚¹ãƒ‘ï¼‰ <span id="Eout">â€”</span></div>
  <div class="result-judge">åˆ¤å®š: <span id="judgement">â€”</span></div>
</section>

<!-- E'ãƒãƒ¼ -->
<section class="card">
  <h2 style="margin:0; font-size:1rem;">E' åˆ¤æ–­ã‚²ãƒ¼ã‚¸</h2>
  <div class="e-bar-container">
    <div class="e-bar-fill" id="Ebar"></div>
    <div class="e-bar-line"></div>
    <div class="e-bar-value" id="EbarValue">â€”</div>
  </div>
  <div class="e-axis" id="Eaxis"></div>
</section>

<!-- å±¥æ­´ -->
<section class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <div style="font-size:0.85rem;color:var(--muted);">å±¥æ­´ã‚’ã‚¿ãƒƒãƒ—ã§èª­ã¿è¾¼ã¿ãƒ»å‰Šé™¤ã¯èµ¤ãƒœã‚¿ãƒ³</div>
    <button id="clearAllBtn" class="btn-ghost btn-small">å…¨ä»¶<br>å‰Šé™¤</button>
  </div>
  <div class="history-list" id="historyList"></div>
</section>

<footer>PWAå¯¾å¿œãƒ»ãƒ©ã‚¤ãƒˆ/ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿å¯</footer>
</div>

<script>
const Iinput=document.getElementById('I');
const Tinput=document.getElementById('T');
const Tunit=document.getElementById('Tunit');
const Cinput=document.getElementById('C');
const kinput=document.getElementById('k');
const C0input=document.getElementById('C0');
const incomeInput=document.getElementById('income');
const calcBtn=document.getElementById('calcBtn');
const calibrateBtn=document.getElementById('calibrateBtn');
const incomeBtn=document.getElementById('incomeBtn');
const saveBtn=document.getElementById('saveBtn');
const exportBtn=document.getElementById('exportBtn');
const clearAllBtn=document.getElementById('clearAllBtn');
const Wout=document.getElementById('Wout');
const Eout=document.getElementById('Eout');
const judgementEl=document.getElementById('judgement');
const historyList=document.getElementById('historyList');
const themeToggle=document.getElementById('themeToggle');
const STORAGE_KEY='Want_history_v1';
const THEME_KEY='theme_mode';

function toNum(v){const n=Number(v);return Number.isFinite(n)?n:NaN;}
function r(v,dp=6){const m=Math.pow(10,dp);return Math.round(v*m)/m;}
function nowIso(){return new Date().toISOString();}
function convertTtoDays(Tval,unit){
  if(!Number.isFinite(Tval))return NaN;
  switch(unit){
    case'week':return Tval*7;
    case'month':return Tval*30;
    case'year':return Tval*365;
    default:return Tval;
  }
}

let lastResult=null;

/* === ä¿®æ­£ç‰ˆ compute() === */
function compute({I,T,C,k}){
  if(!(I>0 && T>0)) return { error:'Iã¨Tã‚’å…¥åŠ›ã—ã¦ãã ã•ã„' };
  const W = I * Math.sqrt(T);
  let E = null;
  if (C > 0 && k > 0) { E = W / (k * Math.sqrt(C)); }
  return { 
    W: r(W), 
    E: E,                // â† ä¸¸ã‚ãšãã®ã¾ã¾
    W_raw: W, 
    E_raw: E 
  };
}

function judgment(E){
  if(!Number.isFinite(E)) return { label:'â€”', color:'var(--muted)' };
  if(E>=3) return { label:'å¼·ãæ¨å¥¨', color:'#3b82f6' };
  if(E>1) return { label:'è‰¯ã„', color:'var(--good)' };
  if(E>=0.7) return { label:'ä¿ç•™', color:'var(--warn)' };
  return { label:'è²»ç”¨éå‰°', color:'var(--bad)' };
}

/* === ä¿®æ­£ç‰ˆ updateResult() === */
function updateResult(res){
  const bar = document.getElementById('Ebar');
  const valEl = document.getElementById('EbarValue');
  const axis = document.getElementById('Eaxis');

  if(res.error){
    Wout.textContent='â€”';
    Eout.textContent='â€”';
    judgementEl.textContent=res.error;
    judgementEl.style.color='var(--bad)';
    Wout.style.color=''; // â† å…ƒã«æˆ»ã™
    bar.style.width='0%';
    bar.style.background='black';
    valEl.textContent='â€”';
    return;
  }

  // Wã¯å¸¸ã«è¡¨ç¤º
  Wout.textContent = res.W.toFixed(6);

  if(res.E === null){
    // --- E'ãŒè¨ˆç®—ã§ããªã„ï¼ˆCã¾ãŸã¯kæœªå…¥åŠ›ãªã©ï¼‰ã®å ´åˆ ---
    Eout.textContent='â€”';
    judgementEl.textContent='â€”';
    judgementEl.style.color='var(--muted)';
    bar.style.width='0%';
    bar.style.background='black';
    valEl.textContent='â€”';

    // â˜… ã“ã®ã¨ãWã‚’ç·‘è‰²ã«ã™ã‚‹
    Wout.style.color = 'var(--good)';

  }else{
    // --- é€šå¸¸è¨ˆç®—ï¼ˆE'ã‚ã‚Šï¼‰ ---
    Eout.textContent = res.E_raw.toFixed(6);
    const j = judgment(res.E_raw);
    judgementEl.textContent = j.label;
    judgementEl.style.color = j.color;

    // â˜… é€šå¸¸ã¯Wã‚’å…ƒã®è‰²ã«æˆ»ã™
    Wout.style.color = '';

    let val = res.E_raw;
    if(!Number.isFinite(val) || val < 0.3){
      bar.style.width = '0%';
      bar.style.background = 'black';
      valEl.textContent = 'â€”';
      return;
    }

    if(val > 7) val = 7;

    let percent;
    if (val <= 1) {
      percent = ((val - 0.3) / (1 - 0.3)) * 50;
    } else {
      percent = 50 + ((val - 1) / (7 - 1)) * 50;
    }
    bar.style.width = percent + '%';
    valEl.textContent = val.toFixed(2);

    let color = 'black';
    if(val < 0.7) color = '#ef4444';
    else if(val < 1) color = '#ffb020';
    else if(val <= 3) color = '#38b000';
    else color = '#3b82f6';

    bar.style.background = color;
  }

 if (axis) {
  axis.innerHTML = `
    <div style="position:absolute; left:0%; transform:translateX(0%); text-align:left;">0.3</div>
    <div style="position:absolute; left:30%; transform:translateX(-50%);">0.7</div>
    <div style="position:absolute; left:50%; transform:translateX(-50%);">1</div>
    <div style="position:absolute; left:69%; transform:translateX(-50%);">3</div>
    <div style="position:absolute; left:100%; transform:translateX(-100%); text-align:right;">7</div>
    `;
  }

  lastResult = res; // å±¥æ­´ä¿å­˜ç”¨
}

calcBtn.onclick=()=>{
  const I=toNum(Iinput.value);
  const T=convertTtoDays(toNum(Tinput.value),Tunit.value);
  const C=toNum(Cinput.value);
  const k=toNum(kinput.value);
  const res=compute({I,T,C,k});
  updateResult(res);
};

calibrateBtn.onclick=()=>{
  const C0=toNum(C0input.value);
  if(!C0||C0<=0){alert('â‘ ã«æœ‰åŠ¹ãªé‡‘é¡ã‚’å…¥åŠ›');return;}
  const k=100/Math.sqrt(C0);
  kinput.value=r(k,6);
  alert('kã‚’ç®—å‡ºã—ã¾ã—ãŸ: '+r(k,6));
};

incomeBtn.onclick=()=>{
  const income=toNum(incomeInput.value);
  if(!income||income<=0){alert('â‘¡ã«æœ‰åŠ¹ãªé‡‘é¡ã‚’å…¥åŠ›');return;}
  const C0=income/3;
  const k=100/Math.sqrt(C0);
  kinput.value=r(k,6);
  alert(`k=${r(k,6)} ã‚’ç®—å‡ºã—ã¾ã—ãŸ`);
};

/* ====== å±¥æ­´ ====== */
saveBtn.onclick=()=>{
  if(!lastResult){alert('ã¾ãšè¨ˆç®—ã—ã¦ãã ã•ã„');return;}
  const memo=prompt('ãƒ¡ãƒ¢ã‚’å…¥åŠ›ï¼ˆä¾‹: æ¬²ã—ã„ç‰©ï¼‰');if(!memo)return;
  const entry={id:'h'+Date.now(),ts:nowIso(),I:toNum(Iinput.value),T:convertTtoDays(toNum(Tinput.value),Tunit.value),C:toNum(Cinput.value),k:toNum(kinput.value),W:lastResult.W,E:lastResult.E,memo:memo.trim()};
  let arr=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');arr.unshift(entry);
  localStorage.setItem(STORAGE_KEY,JSON.stringify(arr));renderHistory();
};

exportBtn.onclick=()=>{
  const arr=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
  if(!arr.length){alert('å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“');return;}
  const rows=[['ts','I','T(æ—¥æ›ç®—)','C','k','W','E','memo']];
  arr.forEach(e=>rows.push([e.ts,e.I,e.T,e.C,e.k,e.W,e.E,e.memo]));
  const csv=new Blob([rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n')],{type:'text/csv'});
  const url=URL.createObjectURL(csv);
  const a=document.createElement('a');a.href=url;a.download='want_history.csv';
  document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);
};

clearAllBtn.onclick=()=>{
  if(confirm('å±¥æ­´ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){localStorage.removeItem(STORAGE_KEY);renderHistory();}
};

function renderHistory(){
  const arr=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');historyList.innerHTML='';
  if(!arr.length){historyList.innerHTML='<div style="color:var(--muted)">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>';return;}
  arr.forEach(item=>{
    const el=document.createElement('div');el.className='hist-item';
    const top=document.createElement('div');top.className='hist-top';
    const meta=document.createElement('div');meta.className='hist-meta';meta.textContent=(new Date(item.ts)).toLocaleString();
    const act=document.createElement('div');
    const loadBtn=document.createElement('button');loadBtn.className='btn-ghost btn-small';loadBtn.textContent='èª­ã¿è¾¼ã¿';
    loadBtn.onclick=()=>{Iinput.value=item.I;Tinput.value=item.T;Cinput.value=item.C;kinput.value=item.k;updateResult(compute({I:item.I,T:item.T,C:item.C,k:item.k}));window.scrollTo({top:0,behavior:'smooth'});};
    const delBtn=document.createElement('button');delBtn.className='btn-danger btn-small';delBtn.textContent='å‰Šé™¤';
    delBtn.onclick=()=>{if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){let arr=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');arr=arr.filter(x=>x.id!==item.id);localStorage.setItem(STORAGE_KEY,JSON.stringify(arr));renderHistory();}};
    act.appendChild(loadBtn);act.appendChild(delBtn);
    top.appendChild(meta);top.appendChild(act);
    const memo=document.createElement('div');memo.className='hist-memo';memo.textContent=item.memo;
    el.appendChild(top);el.appendChild(memo);
    historyList.appendChild(el);
  });
}
renderHistory();

/* ====== ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ ====== */
function applyTheme(mode){
  document.documentElement.classList.toggle('light',mode==='light');
  themeToggle.textContent = mode==='light' ? 'ğŸŒ™' : 'â˜€ï¸';
  localStorage.setItem(THEME_KEY,mode);
}
themeToggle.onclick=()=>{
  const current=document.documentElement.classList.contains('light')?'light':'dark';
  applyTheme(current==='light'?'dark':'light');
};
(function(){
  const saved=localStorage.getItem(THEME_KEY);
  if(saved){applyTheme(saved);}else{
    const prefersLight=window.matchMedia('(prefers-color-scheme: light)').matches;
    applyTheme(prefersLight?'light':'dark');
  }
})();

/* ====== PWA ====== */
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('./sw.js')
      .then(reg=>console.log('SWç™»éŒ²:',reg.scope))
      .catch(err=>console.warn('SWå¤±æ•—:',err));
  });
}
</script>
</body>
</html>