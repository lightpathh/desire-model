<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>欲の持続評価モデル</title>

<!-- PWA -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#7dd3fc">

<style>
  /* --- ダークモバイルファースト --- */
  :root {
    --bg: #071226;
    --card: #07192a;
    --muted: #9fb4c7;
    --text: #e6eef8;
    --accent: #7dd3fc; /* 水色（ボタン等） */
    --good: #38b000; /* 緑 */
    --warn: #ffb020; /* 保留色（橙） */
    --bad: #ef4444;  /* 赤 */
    --pill-bg: rgba(255,255,255,0.02);
  }
  html,body{height:100%}
  body{
    margin:0;
    font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Yu Gothic UI", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
    background: linear-gradient(180deg,var(--bg) 0%, #04111a 100%);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding:18px;
    line-height:1.45;
  }

  .wrap{max-width:640px;margin:0 auto}
  header{display:flex;flex-direction:column;gap:6px;margin-bottom:14px}
  h1{font-size:1.4rem;margin:0}
  .formula{font-size:0.9rem;color:var(--muted)}
  main{display:flex;flex-direction:column;gap:14px}

  .card{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.03);
    padding:14px;border-radius:12px;
    box-shadow:0 6px 18px rgba(0,0,0,0.5);
  }

  label{display:block;font-size:0.9rem;color:var(--muted);margin-bottom:6px}
  input[type="number"], textarea {
    width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);
    background:rgba(255,255,255,0.02);color:var(--text);font-size:1rem;
    box-sizing:border-box;
  }
  textarea {resize:vertical;min-height:56px}

  .controls{display:flex;gap:8px;flex-wrap:wrap}
  button{
    border:0;padding:10px 12px;border-radius:10px;font-weight:700;
    cursor:pointer;
  }
  .btn-primary{background:var(--accent);color:#042029}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)}
  .btn-danger{background:transparent;border:1px solid rgba(255,0,0,0.15);color:var(--text)}
  .btn-small{padding:8px 10px;font-weight:600;border-radius:8px}

  .result-line{display:block;padding:10px;border-radius:10px;background:var(--pill-bg);margin-bottom:6px;font-weight:700}
  .result-value{float:right;font-weight:800}
  .result-judge{padding:10px;border-radius:10px;color:#021008;font-weight:800}

  .history-list{display:flex;flex-direction:column;gap:8px;max-height:300px;overflow:auto;margin-top:8px}
  .hist-item{display:flex;flex-direction:column;padding:10px;border-radius:10px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02)}
  .hist-top{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .hist-meta{font-size:0.85rem;color:var(--muted)}
  .hist-memo{font-weight:800;color:var(--text);margin-top:6px}
  .hist-actions{display:flex;gap:8px;margin-top:8px}
  .del-btn{background:var(--bad);color:white;padding:8px;border-radius:8px;border:0;cursor:pointer}

  .small-note{font-size:0.85rem;color:var(--muted)}
  footer{margin-top:18px;font-size:0.82rem;color:var(--muted);text-align:center;padding-bottom:26px}
  @media (max-width:480px){
    body{padding:12px}
    h1{font-size:1.2rem}
  }
</style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>欲の持続評価モデル</h1>
      <div class="formula">D = I × T<sup>a</sup>　　E' = D / (k × √C)</div>
    </header>

    <main>
      <!-- 入力カード -->
      <section class="card" aria-labelledby="inputs">
        <div id="inputs">
          <label>I（Intensity）: 欲の強度（1〜100）</label>
          <input id="I" type="number" inputmode="decimal" min="0" max="100" step="0.1" placeholder="例: 40" />

          <div style="height:10px"></div>

          <label>T（Time, 日）: 持続日数</label>
          <input id="T" type="number" inputmode="numeric" min="1" max="10000" step="1" placeholder="例: 365" />

          <div style="height:10px"></div>

          <label>C（Cost, 円）: 費用</label>
          <input id="C" type="number" inputmode="numeric" min="0" step="1" placeholder="例: 10000" />

          <div style="height:10px"></div>

          <label>k（スケール定数）: （手動入力可）</label>
          <input id="k" type="number" inputmode="decimal" min="0.0001" step="0.0001" placeholder="空欄でも可（C₀で算出可能）" />

          <div style="height:10px"></div>

          <label>衝動キャリブレーション C₀（円）: 衝動なら出して良い金額を入力すると k を自動補完</label>
          <input id="C0" type="number" inputmode="numeric" min="1" step="1" placeholder="例: 5000" />

          <div style="height:12px"></div>

          <div class="controls">
            <button id="calcBtn" class="btn-primary">計算する</button>
            <button id="calibrateBtn" class="btn-ghost btn-small">C₀ → k を算出</button>
            <button id="saveBtn" class="btn-ghost btn-small">履歴に保存</button>
            <button id="exportBtn" class="btn-ghost btn-small">CSV 出力</button>
          </div>
        </div>
      </section>

      <!-- 結果カード -->
      <section class="card" aria-labelledby="results">
        <div id="results">
          <div class="result-line">D（欲の総量） <span id="Dout" class="result-value">—</span></div>
          <div class="result-line">E'（主観的費用対効果） <span id="Eout" class="result-value">—</span></div>
          <div id="judgeLine" class="result-line result-judge" style="background:var(--pill-bg);color:var(--muted)">判定: <span id="judgement">—</span></div>
          <div class="small-note" style="margin-top:8px">判定：強く推奨（緑） / 良い（緑） / 保留（橙） / 費用過剰（赤）</div>
        </div>
      </section>

      <!-- 履歴カード -->
      <section class="card" aria-labelledby="history">
        <div id="historyTop" style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <label class="small-note">履歴</label>
            <div class="small-note">保存した履歴をタップで読み込み（自動で入力）できます。個別削除は赤ボタン。</div>
          </div>
          <div style="text-align:right">
            <button id="clearAllBtn" class="btn-ghost btn-small">全件削除</button>
          </div>
        </div>

        <div class="history-list" id="historyList" aria-live="polite"></div>
      </section>
    </main>

    <footer>ダークモード・シンプル表示 · PWA 対応</footer>
  </div>

<script>
/* -------------------------
   Core constants & helpers
   ------------------------- */
const STORAGE_KEY = 'desire_model_history_v1';
const VERSION = 'v1';

// DOM
const Iinput = document.getElementById('I');
const Tinput = document.getElementById('T');
const Cinput = document.getElementById('C');
const kinput = document.getElementById('k');
const C0input = document.getElementById('C0');

const calcBtn = document.getElementById('calcBtn');
const calibrateBtn = document.getElementById('calibrateBtn');
const saveBtn = document.getElementById('saveBtn');
const exportBtn = document.getElementById('exportBtn');
const clearAllBtn = document.getElementById('clearAllBtn');

const Dout = document.getElementById('Dout');
const Eout = document.getElementById('Eout');
const judgementEl = document.getElementById('judgement');
const judgeLine = document.getElementById('judgeLine');

const historyList = document.getElementById('historyList');

function toNum(v){ const n = Number(v); return Number.isFinite(n) ? n : NaN; }
function r(v, dp=6){ const m=Math.pow(10,dp); return Math.round(v*m)/m; }
function nowIso(){ return new Date().toISOString(); }

/* -------------------------
   Calculation logic
   ------------------------- */
const defaultA = 0.5; // D = I * T^a

function compute({I,T,C,k,a = defaultA}){
  // require positive C and T and k and I > 0
  if (!(I>0 && T>0 && C>0 && k>0 && a>0)) {
    return {error: 'I, T, C, k, a は正の数である必要があります'};
  }
  const Tpow = Math.pow(T, a);
  const D = I * Tpow;
  const sqrtC = Math.sqrt(C);
  const denom = k * sqrtC;
  const Eprime = D / denom;
  return {
    D_raw: D,
    D: r(D,6),
    E_raw: Eprime,
    E: r(Eprime,6),
    a, Tpow: r(Tpow,8), sqrtC: r(sqrtC,8), denom: r(denom,8)
  };
}

function judgmentFromE(E){
  if (!Number.isFinite(E)) return {label:'計算不能', color:'var(--muted)'};
  if (E >= 3) return {label:'強く推奨', color:'var(--good)'};
  if (E > 1) return {label:'良い', color:'var(--good)'};
  if (E >= 0.7) return {label:'保留', color:'var(--warn)'};
  return {label:'費用過剰', color:'var(--bad)'};
}

/* -------------------------
   UI actions
   ------------------------- */

let lastResult = null;

function updateResultDisplay(res){
  if (res && res.error){
    Dout.textContent = '—';
    Eout.textContent = '—';
    judgementEl.textContent = res.error;
    judgeLine.style.background = 'var(--pill-bg)';
    judgeLine.style.color = 'var(--muted)';
    lastResult = null;
    return;
  }
  Dout.textContent = res.D;
  Eout.textContent = res.E;
  const j = judgmentFromE(res.E_raw);
  judgementEl.textContent = j.label;
  judgeLine.style.background = 'var(--pill-bg)';
  judgeLine.style.color = j.color;
  lastResult = res;
}

calcBtn.addEventListener('click', ()=>{
  const I = toNum(Iinput.value);
  const T = toNum(Tinput.value);
  const C = toNum(Cinput.value);
  const k = toNum(kinput.value);
  const a = defaultA;
  // if k input is empty or NaN, reject and ask to calibrate or input
  if (!k || !Number.isFinite(k)) {
    // allow k empty? The user asked k input feature and C0 to auto-calc. We'll require k present.
    alert('k が未入力です。手動で入力するか「C₀ → k を算出」で自動入力してください。');
    return;
  }
  const res = compute({I,T,C,k,a});
  updateResultDisplay(res);
});

calibrateBtn.addEventListener('click', ()=>{
  const C0 = toNum(C0input.value);
  if (!C0 || C0 <= 0) { alert('C₀ に有効な金額（円）を入力してください（例: 5000）。'); return; }
  const k = 100 / Math.sqrt(C0);
  kinput.value = r(k,6);
  alert('k をキャリブレーションしました。k = ' + r(k,6));
});

saveBtn.addEventListener('click', ()=>{
  // must have a lastResult from compute (i.e., user pressed calc)
  if (!lastResult) {
    alert('まず「計算する」ボタンを押してから保存してください。');
    return;
  }
  const memo = prompt('メモを入力（例: 欲しい物）。※履歴上では太字で表示されます。', '');
  if (memo === null) return; // cancel
  if (memo.trim().length === 0) {
    alert('メモは空にできません。例: 欲しい物');
    return;
  }
  const entry = {
    id: 'h' + Date.now(),
    ts: nowIso(),
    I: toNum(Iinput.value),
    T: toNum(Tinput.value),
    C: toNum(Cinput.value),
    k: toNum(kinput.value),
    a: defaultA,
    D: lastResult.D,
    E: lastResult.E,
    memo: memo.trim()
  };
  const arr = loadHistory();
  arr.unshift(entry);
  while (arr.length > 200) arr.pop();
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
  renderHistory();
  alert('履歴に保存しました。');
});

exportBtn.addEventListener('click', ()=>{
  const arr = loadHistory();
  if (!arr || arr.length === 0) { alert('エクスポートする履歴がありません。'); return; }
  const rows = [['ts','I','T','C','k','a','D','E','memo']];
  arr.forEach(e => rows.push([e.ts,e.I,e.T,e.C,e.k,e.a,e.D,e.E,e.memo]));
  const csv = rows.map(r => r.map(c => '"' + String(c).replace(/"/g,'""') + '"').join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'desire_model_history.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

clearAllBtn.addEventListener('click', ()=>{
  if (!confirm('履歴をすべて削除しますか？')) return;
  localStorage.removeItem(STORAGE_KEY);
  renderHistory();
});

/* -------------------------
   History load / render / delete
   ------------------------- */
function loadHistory(){
  try {
    const s = localStorage.getItem(STORAGE_KEY);
    if (!s) return [];
    const arr = JSON.parse(s);
    if (!Array.isArray(arr)) return [];
    return arr;
  } catch(e){ return []; }
}

function renderHistory(){
  const arr = loadHistory();
  historyList.innerHTML = '';
  if (!arr || arr.length === 0) {
    const p = document.createElement('div');
    p.className = 'small-note';
    p.textContent = '履歴がありません。計算して「履歴に保存」してください。';
    historyList.appendChild(p);
    return;
  }
  arr.forEach(item => {
    const el = document.createElement('div');
    el.className = 'hist-item';
    const top = document.createElement('div');
    top.className = 'hist-top';

    const meta = document.createElement('div');
    meta.className = 'hist-meta';
    meta.textContent = (new Date(item.ts)).toLocaleString();

    const metaRight = document.createElement('div');
    metaRight.style.display = 'flex';
    metaRight.style.gap = '8px';
    const loadBtn = document.createElement('button');
    loadBtn.className = 'btn-ghost btn-small';
    loadBtn.textContent = '読み込み';
    loadBtn.addEventListener('click', ()=> {
      Iinput.value = item.I;
      Tinput.value = item.T;
      Cinput.value = item.C;
      kinput.value = item.k;
      // run calculation automatically after load to reflect values
      const res = compute({I:item.I,T:item.T,C:item.C,k:item.k,a:item.a});
      if (res.error) {
        alert('読み込みしたデータに不備があります: ' + res.error);
        return;
      }
      updateResultDisplay(res);
      window.scrollTo({top:0,behavior:'smooth'});
    });

    const delBtn = document.createElement('button');
    delBtn.className = 'del-btn';
    delBtn.textContent = '削除';
    delBtn.addEventListener('click', ()=> {
      if (!confirm('この履歴を削除しますか？')) return;
      deleteHistoryItem(item.id);
    });

    metaRight.appendChild(loadBtn);
    metaRight.appendChild(delBtn);

    top.appendChild(meta);
    top.appendChild(metaRight);

    const memo = document.createElement('div');
    memo.className = 'hist-memo';
    memo.textContent = item.memo;

    const values = document.createElement('div');
    values.className = 'small-note';
    values.textContent = `I=${item.I}  T=${item.T}日  C=${item.C}円  D=${item.D}  E'=${item.E}`;

    el.appendChild(top);
    el.appendChild(memo);
    el.appendChild(values);

    historyList.appendChild(el);
  });
}

function deleteHistoryItem(id){
  let arr = loadHistory();
  arr = arr.filter(x => x.id !== id);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
  renderHistory();
}

/* -------------------------
   Init / load
   ------------------------- */
(function init(){
  // set placeholders / defaults (but do not auto-calc)
  Iinput.placeholder = '例: 40';
  Tinput.placeholder = '例: 365';
  Cinput.placeholder = '例: 10000';
  renderHistory();
})();

/* -------------------------
   ServiceWorker registration (PWA)
   ------------------------- */
if ('serviceWorker' in navigator) {
  // register at root path to control entire scope
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/sw.js')
      .then(reg => {
        console.log('Service Worker registered. scope=', reg.scope);
      })
      .catch(err => {
        console.warn('Service Worker registration failed:', err);
      });
  });
}
</script>
</body>
</html>